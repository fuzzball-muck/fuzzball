#!/bin/make -f

subdirs=src
RM=rm -f
MAKE=make

all:	Makefile
	for d in ${subdirs}; do \
		cd $${d} && ${MAKE} all; \
	done

install:	Makefile
	for d in ${subdirs}; do \
		cd $${d} && ${MAKE} install; \
	done
	@if grep "^#define HAVE_LIBSSL" include/autoconf.h > /dev/null; then \
	if [ ! -f game/data/server.pem ]; then \
	echo "You can use '${MAKE} cert' to generate a self-signed server certificate"; \
	echo "for use in allowing secure encrypted SSL connections to your Muck."; \
	echo " "; \
	fi; \
	fi

install-sysv-inits:	Makefile
	for d in ${subdirs}; do \
		cd $${d} && ${MAKE} install-sysv-inits; \
	done

cert game/server.pem:
	@if grep "^#define HAVE_LIBSSL" include/autoconf.h > /dev/null; then \
		echo; \
		if [ -r game/data/server.pem ]; then \
			echo "Will not overwrite game/data/server.pem"; \
			echo "Remove that file and do '${MAKE} cert' again";\
			echo "to create a new certificate."; \
			echo; \
		else \
			if [ ! -r ${HOME}/.rnd ]; then \
				openssl rand -rand /etc/hosts:/etc/passwd 0; \
			fi; \
			echo "Creating secure certificate. Please answer all the questions."; \
			echo "The key and certificate will be stored in the game/data/server.pem file."; \
			echo; \
			openssl req -x509 -nodes -out game/data/server.pem -keyout game/data/server.pem -config fuzzball.cnf -new -days 730; \
		fi; \
	fi

clean:
	for d in ${subdirs}; do \
		cd $${d} && ${MAKE} clean; \
	done

nuke:
	for d in ${subdirs}; do \
		cd $${d} && ${MAKE} nuke; \
	done
	${RM} include/autoconf.h
	${RM} Makefile config.status config.cache config.log game/restart

Makefile: Makefile.in
	./config.status Makefile
	@echo Please re-run ${MAKE}, because the Makefile was re-generated.

help:
	for d in ${subdirs}; do \
		cd $${d} && ${MAKE} help; \
	done

#!/bin/make -f
# @configure_input@

# #######################################################################
#                  Makefile for TinyMUCK 2.2fb7
# #######################################################################

# #######################################################################
#			User tunable options
# #######################################################################

#
# Prepend line.  used for compiling with things like nice.
#
# PRE= nice -10

#
# Optimizations
# -O                General optimizations, reccomended.
# -O2               Heavier optimizations, use at own risk.
# -g                Generate debugging information, suggested, you can
#                     always "strip fbmuck" if you want the space.
# -pg               Generate profiling debug code.  Use with gprof.
# -Wall -pedantic	Good way to get spammed with warnings from GCC.
# -ftest-coverage -fprofile-arcs  Generate test coverage debug code for gcov.
#
OPTIM=

#
# Paths
#

# Right below the src/include directories
ROOT= ..

# Where the include files are
INCLUDE= ${ROOT}/include

# The root of the directory tree to install to.
prefix=@prefix@
datarootdir=@datarootdir@
exec_prefix=@exec_prefix@
# Destinations for binaries
INSTALL_BINDIR=@bindir@
INSTALL_SBINDIR=@sbindir@
# Destination for helpfiles
INSTALL_HELPDIR=@datadir@/fbmuck

# #######################################################################
# 		Variables set by the configure script.
# #######################################################################
INSTALL=@INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_SCRIPT=@INSTALL_SCRIPT@
INSTALL_DATA=@INSTALL_DATA@

CC=@CC@
DEFS=@DEFS@
LIBR=@LIBS@
INCL=-I@INC@

# #######################################################################
#  	   Usualy don't need to change anything past here.
# #######################################################################

#
# Include path, Cflags...
#
INCL=-I${INCLUDE} @INC@
CFLAGS=@CFLAGS@ ${OPTIM}
MV= mv -f
CP= cp -f
RM= rm -f
CHMOD= chmod
MAKE= make

##########################################################################
#            You should not have to change anything below here           #
##########################################################################

MALLSRC= crt_malloc.c
MALLOBJ= crt_malloc.o

SRC= array.c boolexp.c compile.c create.c db.c debugger.c diskprop.c edit.c \
	events.c fbmath.c fbsignal.c fbstrings.c fbtime.c game.c hashtab.c help.c \
	interface.c interface_ssl.c interp.c log.c look.c match.c mcp.c mcpgui.c \
	mcppkgs.c mfuns.c mfuns2.c move.c msgparse.c mufevent.c p_array.c \
	p_connects.c p_db.c p_error.c p_float.c p_math.c p_mcp.c p_misc.c \
	p_props.c p_regex.c p_stack.c p_strings.c player.c predicates.c \
	propdirs.c property.c props.c rob.c sanity.c set.c sha1.c speech.c \
	timequeue.c tune.c wiz.c

OBJ= $(SRC:.c=.o)

TARGETS= fbmuck fb-resolver prochelp
OLDTARGETS = fbmuck~ fb-resolver~ prochelp~
HELPFILES= man.txt help.txt mpihelp.txt mpihelp.html mufman.html muckhelp.html

.c.o:
	${PRE} ${CC} ${CFLAGS} ${INCL} ${DEFS} -c $*.c

all: $(INCLUDE)/defines.h ${TARGETS} 

install: all
	${INSTALL} -d ${INSTALL_BINDIR}
	${INSTALL_PROGRAM} ${TARGETS} ${INSTALL_BINDIR}
	${INSTALL} -d ${INSTALL_HELPDIR}
	make help
	${INSTALL_SCRIPT} ../game/restart ${INSTALL_HELPDIR}/restart-script
	@echo " "
	@echo "You may run 'make install-sysv-inits' to install SysV style init scripts."
	@echo " "

install-sysv-inits: all
	-[ -f /etc/fbmucks ] || echo "#MUCKNAME   USERNAME    MUCK_ROOT_PATH           SCRIPTNAME  PORTS" > /etc/fbmucks
	-[ -f /etc/redhat-release ] && ${INSTALL_SCRIPT} ../scripts/fbmuck-redhat-init /etc/rc.d/init.d/fbmuck
	-[ ! -f /etc/redhat-release ] && ${INSTALL_SCRIPT} ../scripts/fbmuck-sysvinit /etc/rc.d/init.d/fbmuck
	-chkconfig --add fbmuck || ( \
		for d in 0 1 2 3 4 5 6; do rm -f /etc/rc.d/rc$$d.d/S??fbmuck; done ; \
		for d in 0 1 2 3 4 5 6; do rm -f /etc/rc.d/rc$$d.d/K??fbmuck; done ; \
		for d in 0 1         6; do ln -s ../init.d/fbmuck /etc/rc.d/rc$$d.d/K23fbmuck; done ; \
		for d in     2 3 4 5  ; do ln -s ../init.d/fbmuck /etc/rc.d/rc$$d.d/S82fbmuck; done ; \
	)

$(INCLUDE)/defines.h:
	@echo Creating $(INCLUDE)/defines.h...
	@echo '/* This file is automatically generated by make. */' > $(INCLUDE)/defines.h
	@echo "#define BINDIR \"$(INSTALL_BINDIR)\"" >> $(INCLUDE)/defines.h

version.c:
	mkversion version.tpl ${OBJ}

fbmuck: $(INCLUDE)/defines.h ${P} ${OBJ} ${MALLOBJ} Makefile
	${PRE} ${CC} ${CFLAGS} ${INCL} ${DEFS} -o mkversion mkversion.c sha1.c
	./mkversion
	${PRE} ${CC} ${CFLAGS} ${INCL} ${DEFS} -c version.c
	if [ -f fbmuck ]; then ${MV} fbmuck fbmuck~ ; fi
	${PRE} ${CC} ${CFLAGS} ${INCL} ${DEFS} -o fbmuck ${OBJ} ${MALLOBJ} version.o \
	  ${LIBR}

fb-resolver: resolver.o ${MALLOBJ} Makefile
	${PRE} ${CC} ${CFLAGS} ${INCL} ${DEFS} -o fb-resolver resolver.o ${MALLOBJ} ${LIBR} -lpthread

prochelp: prochelp.o Makefile
	${PRE} ${CC} ${CFLAGS} ${INCL} ${DEFS} -o prochelp prochelp.o

help: prochelp
	cd ../game/data && ../../src/prochelp mpihelp.raw mpihelp.txt mpihelp.html > /dev/null
	cd ../game/data && ../../src/prochelp mufman.raw man.txt mufman.html > /dev/null
	cd ../game/data && ../../src/prochelp muckhelp.raw help.txt muckhelp.html > /dev/null
	cd ../game/data && ${INSTALL_DATA} ${HELPFILES} ${INSTALL_HELPDIR}

Makefile: Makefile.in
	cd .. && ./config.status
	@echo " "
	@echo Please re-run make, as the Makefile was re-generated.

clean:
	-${RM} ${OBJ} core version.o mkversion.o ${SOBJ} ${MALLOBJ} resolver.o ${TARGETS} ${OLDTARGETS} prochelp.o

nuke: clean
	-${RM} Makefile config.status config.cache config.log ${INCLUDE}/autoconf.h ${TARGETS} version.c mkversion ${INCLUDE}/defines.h
	-${RM} ${OBJ} core version.o mkversion.o
	-${RM} ${TARGETS} *~ *.bak *.orig
	-${RM} Makefile config.status ${INCLUDE}/autoconf.h
